<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Èå≤Èü≥„É°„É¢ Pro - Advanced</title>
    <style>
        :root {
            --primary-color: #007aff; --danger-color: #ff3b30; --success-color: #34c759; --bg-header: #ffffff;
        }
        body {
            margin: 0; display: flex; flex-direction: column; height: 100vh;
            font-family: -apple-system, sans-serif; background: #f2f2f7; overflow: hidden; position: fixed; width: 100%;
        }
        header {
            background: var(--bg-header); padding: 12px 20px; display: flex; flex-wrap: wrap;
            align-items: center; z-index: 2000; box-shadow: 0 4px 12px rgba(0,0,0,0.1); gap: 12px;
        }
        .tool-group { display: flex; background: #efeff4; border-radius: 12px; padding: 3px; border: 1px solid #ddd; }
        .mode-btn, .tool-btn { padding: 10px 18px; border: none; border-radius: 9px; cursor: pointer; font-weight: bold; font-size: 16px; transition: 0.2s; }
        .active { background: white; color: var(--primary-color); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        .color-picker { display: flex; gap: 8px; }
        .color-dot { width: 38px; height: 38px; border-radius: 50%; border: 3px solid #eee; cursor: pointer; position: relative; }
        .color-dot.selected { border-color: #333; transform: scale(1.1); }
        .marker::after { content: "H"; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-size: 12px; font-weight: 900; }

        button.action-btn { padding: 10px 18px; border-radius: 10px; border: none; font-size: 15px; font-weight: bold; cursor: pointer; }
        #recordBtn { background: var(--primary-color); color: white; }
        #stopBtn { background: var(--danger-color); color: white; }
        #undoBtn { background: #fff; border: 1px solid #ccc; }
        #clearBtn { background: #eee; color: var(--danger-color); margin-left: auto; }

        #status-display { font-size: 16px; font-weight: bold; min-width: 120px; text-align: center; }

        #scroll-container { flex-grow: 1; overflow-y: scroll; background: #fff; -webkit-overflow-scrolling: touch; }
        canvas { display: block; background: #fff; touch-action: none; }
    </style>
</head>
<body>
    <header id="app-header">
        <div class="tool-group">
            <button id="drawModeBtn" class="mode-btn active">üñä Êèè„Åè</button>
            <button id="scrollModeBtn" class="mode-btn">‚úã ÁßªÂãï</button>
        </div>

        <div class="color-picker" id="colorPicker">
            <div class="color-dot selected" style="background: #000;" data-color="#000000"></div>
            <div class="color-dot" style="background: #ff3b30;" data-color="#ff3b30"></div>
            <div class="color-dot marker" style="background: #ffff00; border-color: #ddd;" data-color="rgba(255, 255, 0, 0.4)" data-type="marker"></div>
            <div class="color-dot" id="eraserBtn" style="background: #fff; border: 2px solid #ccc;" data-type="eraser">üßΩ</div>
        </div>

        <button id="undoBtn" class="action-btn">‚Ü©Ô∏è Êàª„Çã</button>
        
        <button id="recordBtn" class="action-btn">Èå≤Èü≥</button>
        <button id="stopBtn" class="action-btn" disabled>ÂÅúÊ≠¢</button>
        <div id="status-display">READY</div>

        <button id="saveBtn" class="action-btn" style="background: var(--success-color); color:white;">‰øùÂ≠ò</button>
        <button id="clearBtn" class="action-btn">ÂÖ®Ê∂àÂéª</button>
    </header>

    <div id="scroll-container">
        <canvas id="memoCanvas"></canvas>
    </div>

    <script>
        const canvas = document.getElementById('memoCanvas');
        const container = document.getElementById('scroll-container');
        const ctx = canvas.getContext('2d');
        const statusDisplay = document.getElementById('status-display');
        
        let isDrawing = false;
        let editMode = 'draw';
        let currentColor = '#000000';
        let isEraser = false;
        let isMarker = false;
        let undoStack = [];
        const MAX_UNDO = 20;

        function initCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = 4000;
            ctx.fillStyle = "#ffffff"; ctx.fillRect(0, 0, canvas.width, canvas.height);
            saveState(); // ÂàùÊúüÁä∂ÊÖã„Çí‰øùÂ≠ò
            loadFromLocalStorage();
        }

        function setPenStyle() {
            ctx.globalCompositeOperation = isEraser ? 'destination-out' : 'source-over';
            ctx.strokeStyle = currentColor;
            ctx.lineWidth = isEraser ? 30 : (isMarker ? 20 : 3);
            ctx.lineCap = 'round'; ctx.lineJoin = 'round';
        }

        // Áä∂ÊÖã‰øùÂ≠òÔºàUndoÁî®Ôºâ
        function saveState() {
            if (undoStack.length >= MAX_UNDO) undoStack.shift();
            undoStack.push(canvas.toDataURL());
        }

        document.getElementById('undoBtn').onclick = () => {
            if (undoStack.length > 1) {
                undoStack.pop(); // ÁèæÂú®„ÅÆÁä∂ÊÖã„ÇíÊç®„Å¶„Çã
                const lastState = undoStack[undoStack.length - 1];
                const img = new Image();
                img.src = lastState;
                img.onload = () => {
                    ctx.globalCompositeOperation = 'source-over';
                    ctx.fillStyle = "#ffffff"; ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0);
                    setPenStyle();
                };
            }
        };

        // „ÉÑ„Éº„É´ÂàáÊõø
        document.querySelectorAll('.color-dot').forEach(dot => {
            dot.onclick = () => {
                document.querySelector('.color-dot.selected').classList.remove('selected');
                dot.classList.add('selected');
                isEraser = dot.dataset.type === 'eraser';
                isMarker = dot.dataset.type === 'marker';
                currentColor = dot.dataset.color || '#000000';
                editMode = 'draw';
                updateModeUI();
                setPenStyle();
            };
        });

        const updateModeUI = () => {
            if(editMode === 'draw') {
                document.getElementById('drawModeBtn').classList.add('active');
                document.getElementById('scrollModeBtn').classList.remove('active');
                container.style.overflowY = 'hidden'; // ÊèèÁîª‰∏≠„ÅØ„Çπ„ÇØ„É≠„Éº„É´„ÇíÂÆåÂÖ®„Å´ÊÆ∫„Åô
            } else {
                document.getElementById('scrollModeBtn').classList.add('active');
                document.getElementById('drawModeBtn').classList.remove('active');
                container.style.overflowY = 'scroll';
            }
        };

        document.getElementById('drawModeBtn').onclick = () => { editMode = 'draw'; updateModeUI(); };
        document.getElementById('scrollModeBtn').onclick = () => { editMode = 'scroll'; updateModeUI(); };

        // ÊèèÁîª
        canvas.addEventListener('touchstart', (e) => {
            if (editMode !== 'draw') return;
            isDrawing = true;
            const t = e.touches[0]; const rect = canvas.getBoundingClientRect();
            ctx.beginPath(); ctx.moveTo(t.clientX - rect.left, t.clientY - rect.top);
        }, { passive: false });

        canvas.addEventListener('touchmove', (e) => {
            if (!isDrawing || editMode !== 'draw') return;
            e.preventDefault();
            const t = e.touches[0]; const rect = canvas.getBoundingClientRect();
            ctx.lineTo(t.clientX - rect.left, t.clientY - rect.top); ctx.stroke();
        }, { passive: false });

        canvas.addEventListener('touchend', () => { 
            if(isDrawing) { isDrawing = false; saveState(); saveToLocalStorage(); }
        });

        // Èå≤Èü≥ (ÂêçÂâçÂÖ•Âäõ‰øùÂ≠ò)
        let mediaRecorder; let audioChunks = [];
        document.getElementById('recordBtn').onclick = async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                mediaRecorder.ondataavailable = (e) => audioChunks.push(e.data);
                mediaRecorder.onstop = () => {
                    let name = prompt("„Éï„Ç°„Ç§„É´Âêç:", `Èå≤Èü≥_${new Date().toLocaleTimeString()}`);
                    if(!name) return;
                    const blob = new Blob(audioChunks, { type: 'audio/mp4' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a'); a.href = url; a.download = `${name}.mp4`; a.click();
                    statusDisplay.innerText = "SAVED";
                };
                mediaRecorder.start();
                document.getElementById('recordBtn').disabled = true; document.getElementById('stopBtn').disabled = false;
                statusDisplay.innerText = "‚óè RECORDING";
            } catch (e) { alert(e); }
        };
        document.getElementById('stopBtn').onclick = () => {
            mediaRecorder.stop();
            document.getElementById('recordBtn').disabled = false; document.getElementById('stopBtn').disabled = true;
        };

        // „Åù„ÅÆ‰ªñ
        document.getElementById('saveBtn').onclick = () => {
            let name = prompt("„É°„É¢Âêç:", `„É°„É¢_${new Date().toLocaleTimeString()}`);
            if(!name) return;
            const a = document.createElement('a'); a.href = canvas.toDataURL("image/jpeg", 0.8); a.download = `${name}.jpg`; a.click();
        };
        function saveToLocalStorage() { localStorage.setItem('memoImg', canvas.toDataURL("image/png")); }
        function loadFromLocalStorage() {
            const data = localStorage.getItem('memoImg');
            if (data) { const img = new Image(); img.src = data; img.onload = () => ctx.drawImage(img, 0, 0); }
        }
        document.getElementById('clearBtn').onclick = () => {
            if(confirm("ÂÖ®Ê∂àÂéªÔºü")) { ctx.globalCompositeOperation = 'source-over'; ctx.fillStyle = "#ffffff"; ctx.fillRect(0, 0, canvas.width, canvas.height); saveState(); }
        };

        window.onload = initCanvas;
    </script>
</body>
</html>
