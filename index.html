<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>éŒ²éŸ³ãƒ¡ãƒ¢ ã‚·ãƒ³ãƒ—ãƒ«</title>
    <style>
        :root {
            --primary-color: #007aff; --danger-color: #ff3b30; --success-color: #34c759; --bg-header: #f8f8f8;
        }
        body {
            margin: 0; display: flex; flex-direction: column; height: 100vh;
            font-family: -apple-system, sans-serif; background: #ccc; overflow: hidden; position: fixed; width: 100%;
        }
        header {
            background: var(--bg-header); padding: 12px; display: flex; flex-wrap: wrap;
            gap: 15px; align-items: center; z-index: 2000; box-shadow: 0 2px 10px rgba(0,0,0,0.15);
        }
        /* ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ */
        .mode-selector { display: flex; background: #e0e0e0; border-radius: 12px; padding: 3px; }
        .mode-btn { padding: 12px 24px; border: none; border-radius: 9px; cursor: pointer; font-weight: bold; font-size: 18px; transition: 0.2s; }
        .active { background: white; color: var(--primary-color); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* ã‚«ãƒ©ãƒ¼é¸æŠ */
        .color-picker { display: flex; gap: 10px; margin: 0 10px; }
        .color-dot { width: 40px; height: 40px; border-radius: 50%; border: 3px solid transparent; cursor: pointer; transition: 0.2s; }
        .color-dot.selected { border-color: #555; transform: scale(1.1); }

        /* ãƒœã‚¿ãƒ³ */
        button { padding: 12px 20px; border-radius: 12px; border: none; font-size: 16px; font-weight: bold; cursor: pointer; }
        #recordBtn { background: var(--primary-color); color: white; }
        #stopBtn { background: var(--danger-color); color: white; }
        #stopBtn:disabled { background: #bbb; opacity: 0.5; }
        #saveBtn { background: var(--success-color); color: white; }
        #clearBtn { background: #8e8e93; color: white; margin-left: auto; }

        #status-display { font-size: 18px; font-weight: bold; color: #444; min-width: 120px; text-align: center; }

        #scroll-container { flex-grow: 1; overflow-y: scroll; background: #fafafa; -webkit-overflow-scrolling: touch; }
        canvas { display: block; background: #fff; touch-action: none; }
    </style>
</head>
<body>
    <header id="app-header">
        <div class="mode-selector">
            <button id="drawModeBtn" class="mode-btn active">ğŸ–Š æã</button>
            <button id="scrollModeBtn" class="mode-btn">âœ‹ ç§»å‹•</button>
        </div>

        <div class="color-picker" id="colorPicker">
            <div class="color-dot selected" style="background: #000;" data-color="#000000"></div>
            <div class="color-dot" style="background: #ff3b30;" data-color="#ff3b30"></div>
            <div class="color-dot" style="background: #007aff;" data-color="#007aff"></div>
            <div class="color-dot" style="background: #34c759;" data-color="#34c759"></div>
        </div>
        
        <button id="recordBtn">éŒ²éŸ³é–‹å§‹</button>
        <button id="stopBtn" disabled>åœæ­¢ãƒ»éŸ³å£°ä¿å­˜</button>
        
        <div id="status-display">åœæ­¢ä¸­</div>

        <button id="saveBtn">ãƒ¡ãƒ¢ä¿å­˜(JPG)</button>
        <button id="clearBtn">æ¶ˆå»</button>
    </header>

    <div id="scroll-container">
        <canvas id="memoCanvas"></canvas>
    </div>

    <script>
        const canvas = document.getElementById('memoCanvas');
        const container = document.getElementById('scroll-container');
        const ctx = canvas.getContext('2d', { desynchronized: true });
        const statusDisplay = document.getElementById('status-display');

        let isDrawing = false;
        let editMode = 'draw';
        let currentColor = '#000000';
        let mediaRecorder;
        let audioChunks = [];
        const INITIAL_HEIGHT = 4000;

        function initCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = INITIAL_HEIGHT;
            ctx.fillStyle = "#ffffff"; ctx.fillRect(0, 0, canvas.width, canvas.height);
            setPenStyle(); loadFromLocalStorage();
        }

        function setPenStyle() {
            ctx.lineWidth = 2.5; ctx.lineCap = 'round'; ctx.lineJoin = 'round'; ctx.strokeStyle = currentColor;
        }

        // ã‚«ãƒ©ãƒ¼åˆ‡ã‚Šæ›¿ãˆ
        document.querySelectorAll('.color-dot').forEach(dot => {
            dot.onclick = () => {
                document.querySelector('.color-dot.selected').classList.remove('selected');
                dot.classList.add('selected');
                currentColor = dot.dataset.color;
                setPenStyle();
            };
        });

        // ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
        document.getElementById('drawModeBtn').onclick = (e) => {
            editMode = 'draw'; e.target.classList.add('active');
            document.getElementById('scrollModeBtn').classList.remove('active');
        };
        document.getElementById('scrollModeBtn').onclick = (e) => {
            editMode = 'scroll'; e.target.classList.add('active');
            document.getElementById('drawModeBtn').classList.remove('active');
        };

        function extendCanvasIfNeeded(y) {
            if (y > canvas.height - 800) {
                const tempImage = ctx.getImageData(0, 0, canvas.width, canvas.height);
                canvas.height += 2000; ctx.fillStyle = "#ffffff"; ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.putImageData(tempImage, 0, 0); setPenStyle();
            }
        }

        // æç”»ã‚¤ãƒ™ãƒ³ãƒˆ
        function startDrawing(e) {
            if (editMode !== 'draw') return;
            isDrawing = true;
            const t = e.touches ? e.touches[0] : e;
            const rect = canvas.getBoundingClientRect();
            ctx.beginPath();
            ctx.moveTo(t.clientX - rect.left, t.clientY - rect.top);
        }

        function moveDrawing(e) {
            if (!isDrawing || editMode !== 'draw') return;
            if (e.cancelable) e.preventDefault();
            const t = e.touches ? e.touches[0] : e;
            const rect = canvas.getBoundingClientRect();
            const x = t.clientX - rect.left;
            const y = t.clientY - rect.top;
            ctx.lineTo(x, y); ctx.stroke();
            extendCanvasIfNeeded(y);
        }

        canvas.addEventListener('touchstart', startDrawing, { passive: false });
        canvas.addEventListener('touchmove', moveDrawing, { passive: false });
        canvas.addEventListener('touchend', () => { isDrawing = false; saveToLocalStorage(); });

        // éŒ²éŸ³å‡¦ç†ï¼ˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãªã—ã€ä¿å­˜ç›´çµå‹ï¼‰
        const recordBtn = document.getElementById('recordBtn');
        const stopBtn = document.getElementById('stopBtn');

        recordBtn.onclick = async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const mimeType = 'audio/mp4'; 
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                mediaRecorder.ondataavailable = (e) => { if (e.data.size > 0) audioChunks.push(e.data); };
                
                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/mp4' });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    
                    // ç›´æ¥ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Ÿè¡Œ
                    const link = document.createElement('a');
                    link.href = audioUrl;
                    link.download = `voice_${Date.now()}.mp4`;
                    link.click();
                    
                    statusDisplay.innerText = "åœæ­¢(ä¿å­˜å®Œäº†)";
                    statusDisplay.style.color = "#444";
                };

                mediaRecorder.start();
                recordBtn.disabled = true; stopBtn.disabled = false;
                statusDisplay.innerText = "â— éŒ²éŸ³ä¸­...";
                statusDisplay.style.color = "red";
            } catch (err) { alert("ãƒã‚¤ã‚¯ä½¿ç”¨ã‚’è¨±å¯ã—ã¦ãã ã•ã„: " + err.message); }
        };

        stopBtn.onclick = () => {
            if (mediaRecorder && mediaRecorder.state !== "inactive") {
                mediaRecorder.stop();
                recordBtn.disabled = false; stopBtn.disabled = true;
            }
        };

        // ç”»åƒä¿å­˜
        document.getElementById('saveBtn').onclick = () => {
            const link = document.createElement('a');
            link.href = canvas.toDataURL("image/jpeg", 0.9);
            link.download = `memo_${Date.now()}.jpg`;
            link.click();
        };

        function saveToLocalStorage() { localStorage.setItem('myMemoData', canvas.toDataURL("image/jpeg", 0.5)); }
        function loadFromLocalStorage() {
            const savedData = localStorage.getItem('myMemoData');
            if (savedData) { const img = new Image(); img.src = savedData; img.onload = () => ctx.drawImage(img, 0, 0); }
        }
        document.getElementById('clearBtn').onclick = () => { if(confirm("æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ")) { 
            ctx.fillStyle = "#ffffff"; ctx.fillRect(0, 0, canvas.width, canvas.height); 
            canvas.height = INITIAL_HEIGHT; ctx.fillStyle = "#ffffff"; ctx.fillRect(0, 0, canvas.width, canvas.height);
            setPenStyle(); localStorage.removeItem('myMemoData'); } 
        };
        window.onload = initCanvas;
    </script>
</body>
</html>
