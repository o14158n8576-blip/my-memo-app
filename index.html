<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Èå≤Èü≥„É°„É¢ Pro - Name Entry</title>
    <style>
        :root {
            --primary-color: #007aff;
            --danger-color: #ff3b30;
            --success-color: #34c759;
            --bg-header: #ffffff;
        }
        body {
            margin: 0; display: flex; flex-direction: column; height: 100vh;
            font-family: -apple-system, sans-serif; background: #f2f2f7; overflow: hidden; position: fixed; width: 100%;
        }

        header {
            background: var(--bg-header); padding: 15px 20px; display: flex; align-items: center; 
            z-index: 2000; box-shadow: 0 4px 12px rgba(0,0,0,0.08); gap: 15px;
        }

        .mode-selector { display: flex; background: #efeff4; border-radius: 14px; padding: 4px; border: 1px solid #ddd; }
        .mode-btn { 
            padding: 14px 24px; border: none; border-radius: 11px; cursor: pointer; 
            font-weight: bold; font-size: 18px; transition: all 0.2s; color: #8e8e93;
        }
        .active { background: white; color: var(--primary-color); box-shadow: 0 3px 8px rgba(0,0,0,0.12); }

        .color-picker { display: flex; gap: 12px; }
        .color-dot { width: 42px; height: 42px; border-radius: 50%; border: 3px solid #eee; cursor: pointer; }
        .color-dot.selected { border-color: #000; transform: scale(1.1); }

        button.action-btn { 
            padding: 14px 20px; border-radius: 14px; border: none; font-size: 16px; font-weight: 800; cursor: pointer;
        }
        #recordBtn { background: var(--primary-color); color: white; }
        #stopBtn { background: var(--danger-color); color: white; }
        #stopBtn:disabled { background: #d1d1d6; opacity: 0.6; }
        #saveBtn { background: var(--success-color); color: white; }
        #clearBtn { background: #eee; color: #ff3b30; margin-left: auto; }

        #status-display { 
            font-size: 18px; font-weight: 900; color: #333; min-width: 140px; text-align: center;
            padding: 8px; border-radius: 10px; background: #f8f8f8;
        }

        #scroll-container { flex-grow: 1; overflow-y: scroll; background: #fff; -webkit-overflow-scrolling: touch; }
        canvas { display: block; background: #fff; touch-action: none; }
    </style>
</head>
<body>
    <header id="app-header">
        <div class="mode-selector">
            <button id="drawModeBtn" class="mode-btn active">üñä Êèè„Åè</button>
            <button id="scrollModeBtn" class="mode-btn">‚úã ÁßªÂãï</button>
        </div>

        <div class="color-picker" id="colorPicker">
            <div class="color-dot selected" style="background: #000;" data-color="#000000"></div>
            <div class="color-dot" style="background: #ff3b30;" data-color="#ff3b30"></div>
            <div class="color-dot" style="background: #007aff;" data-color="#007aff"></div>
            <div class="color-dot" style="background: #34c759;" data-color="#34c759"></div>
        </div>
        
        <button id="recordBtn" class="action-btn">Èå≤Èü≥ÈñãÂßã</button>
        <button id="stopBtn" class="action-btn" disabled>ÂÅúÊ≠¢</button>
        
        <div id="status-display">READY</div>

        <button id="saveBtn" class="action-btn">„É°„É¢‰øùÂ≠ò</button>
        <button id="clearBtn" class="action-btn">ÂÖ®Ê∂àÂéª</button>
    </header>

    <div id="scroll-container">
        <canvas id="memoCanvas"></canvas>
    </div>

    <script>
        const canvas = document.getElementById('memoCanvas');
        const ctx = canvas.getContext('2d', { desynchronized: true });
        const statusDisplay = document.getElementById('status-display');
        const recordBtn = document.getElementById('recordBtn');
        const stopBtn = document.getElementById('stopBtn');

        let isDrawing = false;
        let editMode = 'draw';
        let currentColor = '#000000';
        let mediaRecorder;
        let audioChunks = [];
        const INITIAL_HEIGHT = 4000;

        function initCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = INITIAL_HEIGHT;
            ctx.fillStyle = "#ffffff"; ctx.fillRect(0, 0, canvas.width, canvas.height);
            setPenStyle(); loadFromLocalStorage();
        }

        function setPenStyle() {
            ctx.lineWidth = 3; ctx.lineCap = 'round'; ctx.lineJoin = 'round'; ctx.strokeStyle = currentColor;
        }

        // UIÂà∂Âæ°
        document.querySelectorAll('.color-dot').forEach(dot => {
            dot.onclick = () => {
                document.querySelector('.color-dot.selected').classList.remove('selected');
                dot.classList.add('selected');
                currentColor = dot.dataset.color; setPenStyle();
            };
        });

        document.getElementById('drawModeBtn').onclick = (e) => {
            editMode = 'draw'; e.target.classList.add('active');
            document.getElementById('scrollModeBtn').classList.remove('active');
        };
        document.getElementById('scrollModeBtn').onclick = (e) => {
            editMode = 'scroll'; e.target.classList.add('active');
            document.getElementById('drawModeBtn').classList.remove('active');
        };

        // ÊèèÁîª„Éª‰øùÂ≠ò
        canvas.addEventListener('touchstart', (e) => {
            if (editMode !== 'draw') return;
            isDrawing = true;
            const t = e.touches[0]; const rect = canvas.getBoundingClientRect();
            ctx.beginPath(); ctx.moveTo(t.clientX - rect.left, t.clientY - rect.top);
        }, { passive: false });

        canvas.addEventListener('touchmove', (e) => {
            if (!isDrawing || editMode !== 'draw') return;
            if (e.cancelable) e.preventDefault();
            const t = e.touches[0]; const rect = canvas.getBoundingClientRect();
            ctx.lineTo(t.clientX - rect.left, t.clientY - rect.top); ctx.stroke();
        }, { passive: false });

        canvas.addEventListener('touchend', () => { isDrawing = false; saveToLocalStorage(); });

        // Èå≤Èü≥„É≠„Ç∏„ÉÉ„ÇØ
        recordBtn.onclick = async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                mediaRecorder.ondataavailable = (e) => { if (e.data.size > 0) audioChunks.push(e.data); };
                mediaRecorder.onstop = () => {
                    // ÂêçÂâçÂÖ•Âäõ
                    let fileName = prompt("Èü≥Â£∞„Éï„Ç°„Ç§„É´„ÅÆÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ", `voice_${new Date().toLocaleTimeString()}`);
                    if (!fileName) fileName = `voice_${Date.now()}`;

                    const audioBlob = new Blob(audioChunks, { type: 'audio/mp4' });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    const link = document.createElement('a');
                    link.href = audioUrl;
                    link.download = `${fileName}.mp4`;
                    link.click();
                    
                    statusDisplay.innerText = "SAVED";
                    statusDisplay.style.color = "var(--success-color)";
                };
                mediaRecorder.start();
                recordBtn.disabled = true; stopBtn.disabled = false;
                statusDisplay.innerText = "‚óè RECORDING";
                statusDisplay.style.color = "var(--danger-color)";
            } catch (err) { alert("Mic Error: " + err.message); }
        };

        stopBtn.onclick = () => { mediaRecorder.stop(); recordBtn.disabled = false; stopBtn.disabled = true; };

        // „É°„É¢‰øùÂ≠òÊôÇ„ÇÇÂêçÂâç„ÇíËÅû„Åè
        document.getElementById('saveBtn').onclick = () => {
            let fileName = prompt("„É°„É¢„ÅÆÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ", `memo_${new Date().toLocaleTimeString()}`);
            if (!fileName) fileName = `memo_${Date.now()}`;
            
            const link = document.createElement('a');
            link.href = canvas.toDataURL("image/jpeg", 0.9);
            link.download = `${fileName}.jpg`;
            link.click();
        };

        function saveToLocalStorage() { localStorage.setItem('myMemoData', canvas.toDataURL("image/jpeg", 0.5)); }
        function loadFromLocalStorage() {
            const savedData = localStorage.getItem('myMemoData');
            if (savedData) { const img = new Image(); img.src = savedData; img.onload = () => ctx.drawImage(img, 0, 0); }
        }
        document.getElementById('clearBtn').onclick = () => {
            if(confirm("ÂÖ®Ê∂àÂéª„Åó„Åæ„Åô„ÅãÔºü")) {
                ctx.fillStyle = "#ffffff"; ctx.fillRect(0, 0, canvas.width, canvas.height);
                saveToLocalStorage(); statusDisplay.innerText = "CLEARED";
            }
        };
        window.onload = initCanvas;
    </script>
</body>
</html>
